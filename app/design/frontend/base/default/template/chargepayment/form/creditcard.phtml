<?php $tokenRersult = $this->getPaymentTokenResult(); ?>
<?php if($tokenRersult['succes']): ?>
    <script type="text/javascript">
        var reload = false;
        window.CKOConfig = {
            debugMode: false,
            renderMode: 2,
            namespace: 'CheckoutIntegration',
            publicKey: '<?php echo $this->getPublicKey()?>',
            paymentToken: "<?php echo $tokenRersult['token'] ?>",
            value: '<?php echo $this->getAmount() ?>',
            currency: '<?php echo $this->getCurrency() ?>',
            customerEmail: '<?php echo $this->getEmailAddress() ?>',
            customerName: '<?php echo $this->getName()?>',
            paymentMode: 'mixed',
            title: '<?php echo $this->getStoreName(); ?>',
            subtitle:'<?php echo $this->__('Please enter your credit card details') ?>',
            widgetContainerSelector: '.payment-form',
            cardCharged: function(event){

                if($buttonCheckout = $$('.btn-checkout')) {
                    var eventClick = $buttonCheckout[0].readAttribute('data-clickEvent');
                    document.getElementById('cko-cc-paymenToken').value = event.data.paymentToken;
                    IWD.OPC.ckoToken = event.data.paymentToken;
                    IWD.OPC.saveOrderStatus = true;
                    IWD.OPC.ckostatus = false;
                    IWD.OPC.chargeCreated = true;
                    IWD.OPC.savePayment();
//                    $$('.btn-checkout')[0].writeAttribute('onclick', eventClick);
//                    fireEvent($$('.opc-btn-checkout')[0], 'click');

                }
            },
            paymentTokenExpired: function(){
                reload = true;
                IWD.OPC.ckostatus = false;
                IWD.OPC.ckoToken = '';

            },
            lightboxDeactivated: function() {
                IWD.OPC.ckostatus = false;
                if(!IWD.OPC.chargeCreated) {
                    IWD.OPC.ckoToken = '';
                }
                if(reload) {
                    window.location.reload();
                }
            },
            ready: function() {
                if($$('.payment-form')[0].down('link')) {
                    var head = $$('head')[0];
                    head.appendChild($$('.payment-form')[0].down('link'));
                }
                IWD.OPC.ckostatus = false;
                IWD.OPC.bindCKO = false;
            }
        };

        if(typeof Checkout!='undefined' && Checkout.hasOwnProperty('render')) {


            if (IWD.OPC.Checkout.ajaxProgress!=false){
                clearTimeout(IWD.OPC.Checkout.ajaxProgress);
            }

            IWD.OPC.Checkout.ajaxProgress = setTimeout(function(){
                Checkout.render(window.CKOConfig);
            }, 1000);


        }else if(typeof CheckoutIntegration !='undefined' && CheckoutIntegration.hasOwnProperty('render')) {

            if (IWD.OPC.Checkout.ajaxProgress!=false){
                clearTimeout(IWD.OPC.Checkout.ajaxProgress);
            }

            IWD.OPC.Checkout.ajaxProgress = setTimeout(function(){
                CheckoutIntegration.render(window.CKOConfig);
            }, 1000);

//            IWD.OPC.Plugin.event('saveOrderBefore', function() {
//                IWD.OPC.saveOrderStatus = false;
//                $('cko-cc-paymenToken').addClassName('required-entry');
//
//                /CheckoutIntegration.open();
//            });
        }


    </script>

    <div class="payment-form"></div>

    <?php $_code=$this->getMethodCode() ?>
    <ul class="form-list" id="payment_form_<?php echo $_code ?>">
        <li>
            <input type="hidden" name="payment[cko_cc_paymenToken]" id="cko-cc-paymenToken" value="<?php echo
            $this->getPaymentToken() ?>"  class="input-text "/>

        </li>
    </ul>
<?php else:  ?>
    <div style="" id="advice-required-entry-creditcard_cc_token" class="validation-advice">
        <?php echo $this->__($tokenRersult['message']) ?>
    </div>
<?php endif; ?>