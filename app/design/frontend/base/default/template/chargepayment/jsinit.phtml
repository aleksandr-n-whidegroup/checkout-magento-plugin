<?php $tokenResult = $this->getPaymentTokenResult(); ?>

<script type="text/javascript">
    $buttonCheckout =  null;
    <?php if($tokenResult['success']): ?>
        var paymentToken = "<?php echo $tokenResult['token'] ?>";
            if(window.CKOConfig) {
                window.CKOConfig.value = '<?php echo $tokenResult['value'] ?>';
                 window.CKOConfig.paymentToken = paymentToken;
                CheckoutIntegration.configure(window.CKOConfig);
                CheckoutIntegration.render();
            }

    <?php endif; ?>

    function bindClickCko() {

        IWD.OPC.Plugin.event('saveOrderBefore', function() {
            if(!IWD.OPC.ckostatus && IWD.OPC.Shipping.validateShippingMethod()) {
                IWD.OPC.saveOrderStatus = false;
                IWD.OPC.ckostatus = true;
                $('cko-cc-paymenToken').addClassName('required-entry');
                CheckoutIntegration.open();
            }else {
                document.getElementById('cko-cc-paymenToken').value = IWD.OPC.ckoToken;
            }
        });
    }


    var isMobile = false;

    if((typeof Checkout !='undefined' && Checkout.hasOwnProperty('render') && Checkout.isMobile()) ||
        (typeof CheckoutIntegration !='undefined' && CheckoutIntegration.hasOwnProperty('render') &&  CheckoutIntegration.isMobile())
    )  {
        isMobile = true
    }

 if(!isMobile) {
     if (($buttonCheckout = $$('.btn-checkout')).length) {

         var eventClick = $buttonCheckout[0].readAttribute('onclick'),
             clickStatus = IWD.OPC.Checkout.disabledSave;

         document.observe('payment-method:switched', function (event) {
             if (event.memo.method_code == 'creditcard') {
                 bindClickCko();
             } else {
                 $buttonCheckout[0].writeAttribute('data-clickevent', eventClick);
             }
         });

         <?php if($this->isSelected()): ?>

         bindClickCko();

         <?php else: ?>
         IWD.OPC.Plugin.event('saveOrderBefore', function () {

         });
         <?php endif; ?>
         $buttonCheckout[0].writeAttribute('data-clickevent', eventClick);


     }
 }

</script>
